(function(e){function t(t){for(var r,s,c=t[0],o=t[1],u=t[2],p=0,b=[];p<c.length;p++)s=c[p],Object.prototype.hasOwnProperty.call(i,s)&&i[s]&&b.push(i[s][0]),i[s]=0;for(r in o)Object.prototype.hasOwnProperty.call(o,r)&&(e[r]=o[r]);l&&l(t);while(b.length)b.shift()();return a.push.apply(a,u||[]),n()}function n(){for(var e,t=0;t<a.length;t++){for(var n=a[t],r=!0,c=1;c<n.length;c++){var o=n[c];0!==i[o]&&(r=!1)}r&&(a.splice(t--,1),e=s(s.s=n[0]))}return e}var r={},i={app:0},a=[];function s(t){if(r[t])return r[t].exports;var n=r[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=r,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="";var c=window["webpackJsonp"]=window["webpackJsonp"]||[],o=c.push.bind(c);c.push=t,c=c.slice();for(var u=0;u<c.length;u++)t(c[u]);var l=o;a.push([0,"chunk-vendors"]),n()})({0:function(e,t,n){e.exports=n("cd49")},"034f":function(e,t,n){"use strict";var r=n("85ec"),i=n.n(r);i.a},"0d19":function(e,t,n){"use strict";var r=n("2d85"),i=n.n(r);i.a},1:function(e,t){},2:function(e,t){},"2d85":function(e,t,n){},3:function(e,t){},4:function(e,t){},"85ec":function(e,t,n){},cd49:function(e,t,n){"use strict";n.r(t);n("e260"),n("e6cf"),n("cca6"),n("a79d"),n("d1e78"),n("cb5b"),n("da3e8"),n("42b9");var r=n("2b0e"),i=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("v-app",{attrs:{id:"app"}},[n("h1",{staticStyle:{"text-align":"center"}},[e._v("Piping Chat")]),n("p",{staticStyle:{"text-align":"center"}},[e._v(" ðŸ›¡ End-to-End Encryption Chat via "),n("a",{attrs:{href:"https://github.com/nwtgck/piping-server"}},[e._v("Piping Server")]),e._v(" "),n("br"),n("a",{attrs:{href:"https://github.com/nwtgck/piping-chat-web"}},[n("v-icon",[e._v("fab fa-github")]),e._v(" GitHub ")],1)]),n("PipingChat")],1)},a=[],s=n("d4ec"),c=n("99de"),o=n("7e84"),u=n("262e"),l=n("9ab4"),p=n("60a3"),b=function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",[n("v-form",{model:{value:e.isConnectable,callback:function(t){e.isConnectable=t},expression:"isConnectable"}},[n("v-layout",[n("v-flex",{attrs:{xs12:"","offset-sm2":"",sm8:"","offset-md3":"",md6:""}},[n("v-card",{staticStyle:{padding:"1em"}},[n("v-text-field",{attrs:{label:"Server URL",rules:[function(e){return!!e||"Server URL is required"}],required:""},model:{value:e.serverUrl,callback:function(t){e.serverUrl=t},expression:"serverUrl"}}),n("v-text-field",{attrs:{label:"Your ID",rules:[function(e){return!!e||"Your ID is required"}],required:""},model:{value:e.talkerId,callback:function(t){e.talkerId=t},expression:"talkerId"}}),n("v-text-field",{attrs:{label:"Peer ID",placeholder:"e.g. bma",rules:[function(e){return!!e||"Peer ID is required"}],required:""},model:{value:e.peerId,callback:function(t){e.peerId=t},expression:"peerId"}}),n("v-switch",{attrs:{label:"Public key authentication"},model:{value:e.enableSignature,callback:function(t){e.enableSignature=t},expression:"enableSignature"}}),e.enableSignature?n("div",[n("v-alert",{staticStyle:{"margin-bottom":"1em"},attrs:{value:!0,type:"info",outline:""}},[e._v(" NOTE: You can modify your public PEM by "),n("b",[e._v("private one")]),e._v(". ")]),n("v-textarea",{attrs:{label:"Your public RSA PEM",rules:e.publicPrivateSignPemRules,readonly:"",outline:"","prepend-icon":"person"},model:{value:e.publicSignPem,callback:function(t){e.publicSignPem=t},expression:"publicSignPem"}}),n("v-switch",{attrs:{label:"Show/Edit your private PEM",color:"secondary"},model:{value:e.showsPrivateSignPem,callback:function(t){e.showsPrivateSignPem=t},expression:"showsPrivateSignPem"}}),e.showsPrivateSignPem?n("v-textarea",{attrs:{label:"Your private RSA PEM",rules:e.publicPrivateSignPemRules,outline:"","prepend-icon":"lock"},model:{value:e.privateSignPem,callback:function(t){e.privateSignPem=t},expression:"privateSignPem"}}):e._e(),n("v-text-field",{attrs:{label:"Key bits",type:"number"},model:{value:e.nKeyBits,callback:function(t){e.nKeyBits=t},expression:"nKeyBits"}}),n("v-btn",{attrs:{color:"secondary"},on:{click:function(t){return e.assignPrivatePem()}}},[n("v-icon",[e._v("autorenew")]),e._v(" Generate PEMs ")],1),n("v-btn",{attrs:{color:"secondary",disabled:!e.isSignPemSaveable},on:{click:function(t){return e.savePrivateKey()}}},[n("v-icon",[e._v("save")]),e._v(" Save PEMs ")],1),n("v-btn",{attrs:{color:"secondary",disabled:!e.isSignPemErasable},on:{click:function(t){return e.erasePrivateKey()}}},[n("v-icon",[e._v("delete")]),e._v(" Erase PEMs ")],1),n("v-textarea",{staticStyle:{"padding-top":"3em"},attrs:{label:"Peer's public RSA PEM",outline:"","prepend-icon":"person",rules:[function(e){return!!e||"Peer's public RSA is required"}]},model:{value:e.peerPublicSignPem,callback:function(t){e.peerPublicSignPem=t},expression:"peerPublicSignPem"}})],1):e._e(),n("v-btn",{attrs:{color:"primary",disabled:!e.isConnectable||e.isConnecting,block:""},on:{click:function(t){return e.connectToPeer()}}},[n("v-icon",[e._v("fas fa-plug")]),e._v(" Connect ")],1)],1),n("v-expansion-panel",[n("v-expansion-panel-content",{scopedSlots:e._u([{key:"header",fn:function(){return[n("v-icon",[e._v("person")]),n("div",[e._v("Connection details")])]},proxy:!0}])},[n("v-card",{staticStyle:{padding:"1em"}},[n("v-text-field",{attrs:{label:"Session ID",value:e.sessionId,placeholder:" ",readonly:""}}),n("v-textarea",{attrs:{label:"Your public JWK for encryption",readonly:"","prepend-icon":"public",outline:""},model:{value:e.publicEncryptJwkString,callback:function(t){e.publicEncryptJwkString=t},expression:"publicEncryptJwkString"}}),n("v-switch",{attrs:{label:"Show private JWK for encryption",color:"secondary"},model:{value:e.showsPrivateEncryptJwk,callback:function(t){e.showsPrivateEncryptJwk=t},expression:"showsPrivateEncryptJwk"}}),e.showsPrivateEncryptJwk?n("v-textarea",{attrs:{label:"Your private JWK for encryption",readonly:"","prepend-icon":"vpn_key",outline:""},model:{value:e.privateEncryptJwkString,callback:function(t){e.privateEncryptJwkString=t},expression:"privateEncryptJwkString"}}):e._e(),n("h4"),n("v-textarea",{attrs:{label:"Peer's public JWK for encryption",readonly:"","prepend-icon":"public",placeholder:" ",outline:""},model:{value:e.peerPublicEncryptJwkString,callback:function(t){e.peerPublicEncryptJwkString=t},expression:"peerPublicEncryptJwkString"}})],1)],1)],1)],1)],1)],1),n("div",{staticStyle:{margin:"1em"}},[n("v-layout",[n("v-flex",{attrs:{"offset-md1":"",md10:"","offset-lg2":"",lg8:""}},[e.isEstablished?n("v-container",{attrs:{fluid:""}},[n("v-layout",{attrs:{column:""}},[n("v-flex",[n("v-textarea",{attrs:{label:"Your talk",outline:"","hide-details":""},model:{value:e.talk,callback:function(t){e.talk=t},expression:"talk"}})],1),n("v-flex",{attrs:{"offset-xs9":"",xs3:"","offset-lg11":"",lg1:""}},[n("v-btn",{attrs:{disabled:""===e.talk,color:"secondary",block:""},on:{click:function(t){return e.sendTalk()}}},[n("v-icon",[e._v("send")]),e._v(" Send ")],1)],1)],1)],1):e._e(),e._l(e.talks,(function(t){return n("div",["user"===t.kind?n("span",[t.talkerId!==e.talkerId?n("span",[e._v(" "+e._s(t.talkerId)+" ")]):e._e(),n("div",{class:{me:t.talkerId===e.talkerId,peer:t.talkerId!==e.talkerId,talk:!0}},[n("pre",[e._v(e._s(t.content))]),n("span",{staticStyle:{color:"#444"}},[t.talkerId===e.talkerId?n("span",[e._v(" "+e._s(t.arrived?"âœ“":"")+" ")]):e._e(),n("time-ago",{staticClass:"time",attrs:{refresh:60,datetime:t.time}})],1)])]):e._e(),"system"===t.kind?n("span",{staticStyle:{"font-size":"1.5em"}},[n("b",[e._v("System")]),e._v(" "),n("time-ago",{staticClass:"time",attrs:{refresh:60,datetime:t.time}}),e._v(": "+e._s(t.content)+" ")],1):e._e()])}))],2)],1)],1)],1)},d=[],v=(n("a4d3"),n("99af"),n("4de4"),n("4160"),n("a630"),n("a15b"),n("d81d"),n("ace4"),n("0d03"),n("e439"),n("dbb4"),n("b64b"),n("d3b7"),n("3ca3"),n("5cc6"),n("fb2c"),n("9a8c"),n("a975"),n("735e"),n("c1ac"),n("d139"),n("3a7b"),n("d5d6"),n("82f8"),n("e91f"),n("60bd"),n("5f96"),n("3280"),n("3fcc"),n("ca91"),n("25a1"),n("cd26"),n("3c5d"),n("2954"),n("649e"),n("219c"),n("170b"),n("b39a"),n("72f7"),n("159b"),n("ade3")),y=(n("96cf"),n("bee2")),h=n("1da1"),f=n("62ed"),m=n("720d"),g=n("b519"),k=(n("fb6a"),n("25f0"),n("ddb0"),n("53ca")),P=n("3452"),w=n("434c"),S=function(){function e(){Object(s["a"])(this,e),this.prev=Promise.resolve()}return Object(y["a"])(e,[{key:"run",value:function(e){return this.prev=this.prev.then((function(){return e()})).catch((function(){return e()})),this.prev}}]),e}(),x=n("2909");function j(e,t){return E.apply(this,arguments)}function E(){return E=Object(h["a"])(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=Object(g["pem2jwk"])(n),e.abrupt("return",window.crypto.subtle.importKey("jwk",r,t,!0,["verify"]));case 2:case"end":return e.stop()}}),e)}))),E.apply(this,arguments)}function O(e,t){return I.apply(this,arguments)}function I(){return I=Object(h["a"])(regeneratorRuntime.mark((function e(t,n){var r,i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=new m["JSEncrypt"],r.setPrivateKey(n),i=r.getPublicKey(),a=Object(g["pem2jwk"])(n),e.next=6,j(t,i);case 6:return e.t0=e.sent,e.next=9,window.crypto.subtle.importKey("jwk",a,t,!0,["sign"]);case 9:return e.t1=e.sent,e.abrupt("return",{publicKey:e.t0,privateKey:e.t1});case 11:case"end":return e.stop()}}),e)}))),I.apply(this,arguments)}function K(e){return String.fromCharCode.apply(String,Object(x["a"])(new Uint8Array(e)))}function _(e){var t=[].map.call(e,(function(e){return e.charCodeAt(0)}));return new Uint8Array(t).buffer}function R(e){return T.apply(this,arguments)}function T(){return T=Object(h["a"])(regeneratorRuntime.mark((function e(t){var n,r,i,a,s,c,o,u,l,p,b;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(null!==t.body){e.next=2;break}return e.abrupt("return",new Uint8Array);case 2:n=t.body.getReader(),r=[],i=0;case 5:return e.next=8,n.read();case 8:if(a=e.sent,s=a.done,c=a.value,!s){e.next=13;break}return e.abrupt("break",17);case 13:i+=c.byteLength,r.push(c),e.next=5;break;case 17:for(o=new Uint8Array(i),u=0,l=0,p=r;l<p.length;l++)b=p[l],o.set(b,u),u+=b.byteLength;return e.abrupt("return",o);case 21:case"end":return e.stop()}}),e)}))),T.apply(this,arguments)}function C(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(e,0),n.set(t,e.byteLength),n}var A=n("62f3"),J=Object(w["obj"])({d:Object(w["opt"])(w["str"]),r:Object(w["opt"])(w["str"]),t:Object(w["opt"])(w["str"])}),U=Object(w["obj"])({alg:Object(w["opt"])(w["str"]),crv:Object(w["opt"])(w["str"]),d:Object(w["opt"])(w["str"]),dp:Object(w["opt"])(w["str"]),dq:Object(w["opt"])(w["str"]),e:Object(w["opt"])(w["str"]),ext:Object(w["opt"])(w["bool"]),k:Object(w["opt"])(w["str"]),key_ops:Object(w["opt"])(Object(w["arr"])(w["str"])),kty:Object(w["opt"])(w["str"]),n:Object(w["opt"])(w["str"]),oth:Object(w["opt"])(Object(w["arr"])(J)),p:Object(w["opt"])(w["str"]),q:Object(w["opt"])(w["str"]),qi:Object(w["opt"])(w["str"]),use:Object(w["opt"])(w["str"]),x:Object(w["opt"])(w["str"]),y:Object(w["opt"])(w["str"])}),M=Object(w["obj"])({kind:Object(w["literal"])("key_exchange"),content:Object(w["obj"])({sessionIdPublicJwk:U,encryptPublicJwk:U})}),D=Object(w["obj"])({kind:Object(w["literal"])("session_id_signature"),content:w["str"]}),G=Object(w["obj"])({kind:Object(w["literal"])("talk"),content:w["str"]}),L=Object(w["union"])(M,D,G);function N(e,t){return P["SHA256"]("".concat(e,"-to-").concat(t)).toString()}function q(e,t){return B.apply(this,arguments)}function B(){return B=Object(h["a"])(regeneratorRuntime.mark((function e(t,n){var r,i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,crypto.subtle.importKey("jwk",t,{name:"ECDH",namedCurve:"P-256"},!0,[]);case 2:return r=e.sent,e.next=5,crypto.subtle.deriveKey({name:"ECDH",public:r},n,{name:"AES-GCM",length:128},!0,["encrypt","decrypt"]);case 5:return i=e.sent,e.next=8,window.crypto.subtle.exportKey("jwk",i);case 8:return a=e.sent,e.abrupt("return",Object(A["jwkThumbprintByEncoding"])(a,"SHA-256","hex"));case 10:case"end":return e.stop()}}),e)}))),B.apply(this,arguments)}var Y=function(){function e(t){var n=this;Object(s["a"])(this,e),this.params=t,this.aesGcmIvLength=12,this.sessionIdKeyPairPromise=window.crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]),this.sessionId="",this.recieveSeqCtx=new S,this.sendSeqCtx=new S,this.signAlg={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},this.hasPublicKeySent=!1,this.hasPeerPublicKeyReceived=!1,this.peerVerified=!1,this.hasBeenEmitEstablished=!1,this.encryptKeyPairPromise=window.crypto.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveKey","deriveBits"]),this.encryptKeyPairPromise.then((function(e){n.params.onEncryptKeyPair(e)}))}return Object(y["a"])(e,[{key:"connectToPeer",value:function(){this.sendPublicKey(),this.receiveParcelLoop()}},{key:"sendTalk",value:function(e){var t=this,n={kind:"user",time:new Date,talkerId:this.params.connectId,content:e,arrived:!1};this.params.onTalk(n);var r=e;Object(h["a"])(regeneratorRuntime.mark((function e(){var i,a,s;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(i="".concat(t.params.serverUrl,"/").concat(N(t.params.connectId,t.params.peerConnectId)),void 0!==t.peerEncryptPublicCryptoKey){e.next=5;break}t.echoSystemTalk("Peer's public key is not received yet."),e.next=11;break;case 5:return a={kind:"talk",content:r},e.next=8,t.encryptParcel(a,t.peerEncryptPublicCryptoKey);case 8:return s=e.sent,e.next=11,t.sendSeqCtx.run(Object(h["a"])(regeneratorRuntime.mark((function e(){var r;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,fetch(i,{method:"POST",body:s});case 2:if(r=e.sent,null!==r.body){e.next=7;break}t.echoSystemTalk("Unexpected error: send-body is null."),e.next=10;break;case 7:return e.next=9,r.body.pipeTo(new WritableStream({}));case 9:n.arrived=!0;case 10:case"end":return e.stop()}}),e)}))));case 11:case"end":return e.stop()}}),e)})))()}},{key:"encryptParcel",value:function(){var e=Object(h["a"])(regeneratorRuntime.mark((function e(t,n){var r,i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return r=crypto.getRandomValues(new Uint8Array(this.aesGcmIvLength)),e.next=3,this.getSecretKey(n);case 3:return i=e.sent,e.next=6,crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:128},i,(new TextEncoder).encode(JSON.stringify(t)));case 6:return a=e.sent,e.abrupt("return",C(r,new Uint8Array(a)));case 8:case"end":return e.stop()}}),e,this)})));function t(t,n){return e.apply(this,arguments)}return t}()},{key:"echoSystemTalk",value:function(e){this.params.onTalk({kind:"system",time:new Date,content:e})}},{key:"sendPublicKey",value:function(){var e=Object(h["a"])(regeneratorRuntime.mark((function e(){var t,n,r,i,a;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.echoSystemTalk('Sending your public key to "'.concat(this.params.peerConnectId,'"...')),e.t0=crypto.subtle,e.next=4,this.sessionIdKeyPairPromise;case 4:return e.t1=e.sent.publicKey,e.next=7,e.t0.exportKey.call(e.t0,"jwk",e.t1);case 7:return t=e.sent,e.t2=crypto.subtle,e.next=11,this.encryptKeyPairPromise;case 11:return e.t3=e.sent.publicKey,e.next=14,e.t2.exportKey.call(e.t2,"jwk",e.t3);case 14:return n=e.sent,r="".concat(this.params.serverUrl,"/").concat(N(this.params.connectId,this.params.peerConnectId)),i={kind:"key_exchange",content:{sessionIdPublicJwk:t,encryptPublicJwk:n}},console.log("parcel:",JSON.stringify(i)),e.next=20,this.sendSeqCtx.run((function(){return fetch(r,{method:"POST",headers:{"content-type":"text/plain"},body:JSON.stringify(i)})}));case 20:a=e.sent,this.echoSystemTalk("Your public key sent."),this.hasPublicKeySent=!0,this.establishProcessIfNeed(),console.log("res:",a);case 25:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"establishProcessIfNeed",value:function(){!this.hasBeenEmitEstablished&&this.isEstablished&&(this.hasBeenEmitEstablished=!0,this.echoSystemTalk('Connection established with "'.concat(this.params.peerConnectId,'"!')),this.params.onEstablished())}},{key:"receiveParcelLoop",value:function(){var e=Object(h["a"])(regeneratorRuntime.mark((function e(){var t,n,r=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:t="".concat(this.params.serverUrl,"/").concat(N(this.params.peerConnectId,this.params.connectId));case 1:return e.prev=2,e.delegateYield(regeneratorRuntime.mark((function e(){var n,i,a,s,c,o,u,l,p,b,d,v,y;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return console.log("Getting ".concat(t,"...")),e.next=3,r.recieveSeqCtx.run((function(){return fetch(t,{method:"GET"})}));case 3:if(n=e.sent,null!==n.body){e.next=7;break}return console.log("ERROR: Body not found"),e.abrupt("return",{v:void 0});case 7:return e.next=9,Object(h["a"])(regeneratorRuntime.mark((function e(){var t,i,a,s,c;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if("text/plain"!==n.headers.get("content-type")){e.next=9;break}return e.t0=w["validatingParse"],e.t1=L,e.next=5,n.text();case 5:return e.t2=e.sent,e.abrupt("return",(0,e.t0)(e.t1,e.t2));case 9:if(void 0!==r.peerEncryptPublicCryptoKey){e.next=12;break}return console.error("Error: this.peerPublicCryptoKey is undefined"),e.abrupt("return",void 0);case 12:return e.next=14,R(n);case 14:return t=e.sent,i=t.slice(0,r.aesGcmIvLength),a=t.slice(r.aesGcmIvLength),console.log("body:",t),e.next=20,r.getSecretKey(r.peerEncryptPublicCryptoKey);case 20:return s=e.sent,e.next=23,crypto.subtle.decrypt({name:"AES-GCM",iv:i,tagLength:128},s,a);case 23:return c=e.sent,e.abrupt("return",Object(w["validatingParse"])(L,(new TextDecoder).decode(c)));case 25:case"end":return e.stop()}}),e)})))();case 9:if(i=e.sent,void 0!==i){e.next=19;break}return e.t0=console,e.t1="Parse error: ",e.next=15,n.json();case 15:return e.t2=e.sent,e.t3=e.t1.concat.call(e.t1,e.t2),e.t0.error.call(e.t0,e.t3),e.abrupt("return",{v:void 0});case 19:e.t4=i.kind,e.next="key_exchange"===e.t4?22:"session_id_signature"===e.t4?57:"talk"===e.t4?79:83;break;case 22:return a=i.content.encryptPublicJwk,console.log("Peer's public JWK:",a),e.t5=q,e.t6=i.content.sessionIdPublicJwk,e.next=28,r.sessionIdKeyPairPromise;case 28:return e.t7=e.sent.privateKey,e.next=31,(0,e.t5)(e.t6,e.t7);case 31:return r.sessionId=e.sent,r.params.onSessionId(r.sessionId),console.log("Session ID:",r.sessionId),e.next=36,crypto.subtle.importKey("jwk",a,{name:"ECDH",namedCurve:"P-256"},!0,[]);case 36:if(r.peerEncryptPublicCryptoKey=e.sent,r.params.onPeerEncryptPublicCryptoKey(r.peerEncryptPublicCryptoKey),r.echoSystemTalk("Peer's public key received."),r.hasPeerPublicKeyReceived=!0,!r.params.enableSignature){e.next=55;break}return e.next=43,O(r.signAlg,r.params.privateSignPem);case 43:return s=e.sent,c=s.privateKey,e.next=47,window.crypto.subtle.sign(r.signAlg,c,_(r.sessionId));case 47:return o=e.sent,u=btoa(K(o)),console.log("send signature:",u),l={kind:"session_id_signature",content:u},e.next=53,r.encryptParcel(l,r.peerEncryptPublicCryptoKey);case 53:p=e.sent,r.sendSeqCtx.run(Object(h["a"])(regeneratorRuntime.mark((function e(){var t,n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t="".concat(r.params.serverUrl,"/").concat(N(r.params.connectId,r.params.peerConnectId)),e.next=3,fetch(t,{method:"POST",body:p});case 3:if(n=e.sent,null!==n.body){e.next=8;break}r.echoSystemTalk("Unexpected error: send-body is null."),e.next=10;break;case 8:return e.next=10,n.body.pipeTo(new WritableStream({}));case 10:case"end":return e.stop()}}),e)}))));case 55:return r.establishProcessIfNeed(),e.abrupt("break",83);case 57:if(""!==r.sessionId){e.next=60;break}return console.error("Unexpected Error: session is empty"),e.abrupt("break",83);case 60:return b=i.content,console.log("receive signature:",b),d=_(atob(b)),e.next=65,j(r.signAlg,r.params.peerPublicSignPem);case 65:return v=e.sent,e.next=68,window.crypto.subtle.verify(r.signAlg,v,d,_(r.sessionId));case 68:if(r.peerVerified=e.sent,console.log("verified:",r.peerVerified),!r.peerVerified){e.next=74;break}r.echoSystemTalk("Peer was verified!"),e.next=77;break;case 74:return r.echoSystemTalk("Error: Peer was not verified."),r.echoSystemTalk("Error: Connection was not established."),e.abrupt("break",83);case 77:return r.establishProcessIfNeed(),e.abrupt("break",83);case 79:return y={kind:"user",time:new Date,talkerId:r.params.peerConnectId,content:i.content,arrived:!0},console.log("userTalk:",y),r.params.onTalk(y),e.abrupt("break",83);case 83:case"end":return e.stop()}}),e)}))(),"t0",4);case 4:if(n=e.t0,"object"!==Object(k["a"])(n)){e.next=7;break}return e.abrupt("return",n.v);case 7:e.next=12;break;case 9:e.prev=9,e.t1=e["catch"](2),console.error("Error:",e.t1);case 12:e.next=1;break;case 14:case"end":return e.stop()}}),e,this,[[2,9]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"getSecretKey",value:function(){var e=Object(h["a"])(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.t0=crypto.subtle,e.t1={name:"ECDH",public:t},e.next=4,this.encryptKeyPairPromise;case 4:return e.t2=e.sent.privateKey,e.t3={name:"AES-GCM",length:128},e.t4=["encrypt","decrypt"],e.abrupt("return",e.t0.deriveKey.call(e.t0,e.t1,e.t2,e.t3,!1,e.t4));case 8:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"isEstablished",get:function(){return this.hasPublicKeySent&&this.hasPeerPublicKeyReceived&&(!this.params.enableSignature||this.peerVerified)}}]),e}();function V(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function H(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?V(Object(n),!0).forEach((function(t){Object(v["a"])(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):V(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function W(e){var t=["a","b","c","d","e","f","h","i","j","k","m","n","p","r","s","t","u","v","w","x","y","z"],n=[].concat(t),r=window.crypto.getRandomValues(new Uint32Array(e));return Array.from(r).map((function(e){return n[e%n.length]})).join("")}function $(e){return z.apply(this,arguments)}function z(){return z=Object(h["a"])(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,window.crypto.subtle.exportKey("jwk",t);case 2:return n=e.sent,e.abrupt("return",JSON.stringify(n,null,"  "));case 4:case"end":return e.stop()}}),e)}))),z.apply(this,arguments)}function F(e){if(""!==e)try{var t=new m["JSEncrypt"];return t.setPrivateKey(e),t.getPublicKey()}catch(n){return}}var Q={PRIVATE_SIGNATURE_PEM:"LOCAL_STORAGE_KEY/PRIVATE_SIGNATURE_PEM"},X=function(e){function t(){var e;return Object(s["a"])(this,t),e=Object(c["a"])(this,Object(o["a"])(t).apply(this,arguments)),e.isEstablished=!1,e.isConnecting=!1,e.isConnectable=!1,e.serverUrl="https://ppng.io",e.peerId="",e.talkerId=W(3),e.talks=[],e.talk="",e.nKeyBits=4096,e.sessionId="",e.enableSignature=!1,e.privateSignPem="",e.peerPublicSignPem="",e.showsPrivateSignPem=!1,e.showsPrivateEncryptJwk=!1,e.signAlg={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},e.isSignPemErasable=!1,e.publicEncryptJwkString="",e.privateEncryptJwkString="",e.peerPublicEncryptJwkString="",e}return Object(u["a"])(t,e),Object(y["a"])(t,[{key:"mounted",value:function(){var e=localStorage.getItem(Q.PRIVATE_SIGNATURE_PEM);null!==e&&(this.privateSignPem=e,this.isSignPemErasable=!0,this.echoSystemTalk("ðŸ”‘ Your private PEM loaded!"))}},{key:"connectToPeer",value:function(){var e=this;this.pipingChatter=new Y({serverUrl:this.serverUrl,connectId:this.talkerId,peerConnectId:this.peerId,enableSignature:this.enableSignature,privateSignPem:this.privateSignPem,peerPublicSignPem:this.peerPublicSignPem,onSessionId:function(t){p["b"].nextTick((function(){e.sessionId=t}))},onEstablished:function(){p["b"].nextTick((function(){e.isEstablished=!0}))},onEncryptKeyPair:function(t){p["b"].nextTick(Object(h["a"])(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,$(t.publicKey);case 2:return e.publicEncryptJwkString=n.sent,n.next=5,$(t.privateKey);case 5:e.privateEncryptJwkString=n.sent;case 6:case"end":return n.stop()}}),n)}))))},onPeerEncryptPublicCryptoKey:function(t){p["b"].nextTick(Object(h["a"])(regeneratorRuntime.mark((function n(){return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.next=2,$(t);case 2:e.peerPublicEncryptJwkString=n.sent;case 3:case"end":return n.stop()}}),n)}))))},onTalk:function(t){p["b"].nextTick((function(){e.talks.unshift(t)}))}}),this.pipingChatter.connectToPeer(),this.isConnecting=!0}},{key:"sendTalk",value:function(){void 0===this.pipingChatter?console.error("Unexpected error: piping chatter is not defined"):(this.pipingChatter.sendTalk(this.talk),this.talk="")}},{key:"echoSystemTalk",value:function(e){this.talks.unshift({kind:"system",time:new Date,content:e})}},{key:"assignPrivatePem",value:function(){var e=Object(h["a"])(regeneratorRuntime.mark((function e(){var t,n,r,i,a,s=this;return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return this.echoSystemTalk("".concat(this.nKeyBits,"-bit key generating...")),t=new Date,n=setInterval((function(){var e=((new Date).getTime()-t.getTime())/1e3;s.echoSystemTalk("".concat(s.nKeyBits,"-bit key generating... (").concat(e," sec passed)"))}),4e3),e.next=5,window.crypto.subtle.generateKey(H({},this.signAlg,{modulusLength:this.nKeyBits,publicExponent:new Uint8Array([1,0,1])}),!0,["sign","verify"]);case 5:return r=e.sent,clearInterval(n),e.next=9,window.crypto.subtle.exportKey("jwk",r.privateKey);case 9:i=e.sent,void 0!==i.kty&&void 0!==i.n&&void 0!==i.e?(a=H({},i,{kty:i.kty,n:i.n,e:i.e}),this.privateSignPem=Object(g["jwk2pem"])(a),this.echoSystemTalk("ðŸ”‘ ".concat(this.nKeyBits,"-bit PEM generated!"))):this.echoSystemTalk("Error: ".concat(this.nKeyBits,"-bit PEM not generated"));case 11:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"savePrivateKey",value:function(){""!==this.privateSignPem&&(localStorage.setItem(Q.PRIVATE_SIGNATURE_PEM,this.privateSignPem),this.isSignPemErasable=!0,this.echoSystemTalk("Your private PEM saved."))}},{key:"erasePrivateKey",value:function(){null===localStorage.getItem(Q.PRIVATE_SIGNATURE_PEM)?this.echoSystemTalk("Private PEM is not saved yet."):(localStorage.removeItem(Q.PRIVATE_SIGNATURE_PEM),this.isSignPemErasable=!1,this.echoSystemTalk("Your private PEM erased from local storage."))}},{key:"publicSignPem",get:function(){if(""===this.privateSignPem)return"";var e=F(this.privateSignPem);return void 0===e?"INVALID PRIVATE KEY":e}},{key:"isSignPemSaveable",get:function(){return void 0!==F(this.privateSignPem)}},{key:"publicPrivateSignPemRules",get:function(){var e=this;return[function(t){return!e.enableSignature||(void 0!==F(e.privateSignPem)||"Your private RSA PEM is not valid")}]}}]),t}(p["b"]);X=Object(l["a"])([Object(p["a"])({components:{TimeAgo:f["a"]}})],X);var Z=X,ee=Z,te=(n("0d19"),n("2877")),ne=Object(te["a"])(ee,b,d,!1,null,"06427cf8",null),re=ne.exports,ie=function(e){function t(){return Object(s["a"])(this,t),Object(c["a"])(this,Object(o["a"])(t).apply(this,arguments))}return Object(u["a"])(t,e),t}(p["b"]);ie=Object(l["a"])([Object(p["a"])({components:{PipingChat:re}})],ie);var ae=ie,se=ae,ce=(n("034f"),Object(te["a"])(se,i,a,!1,null,null,null)),oe=ce.exports,ue=n("9483");Object(ue["a"])("".concat("","service-worker.js"),{ready:function(){console.log("App is being served from cache by a service worker.\nFor more details, visit https://goo.gl/AFskqB")},registered:function(){console.log("Service worker has been registered.")},cached:function(){console.log("Content has been cached for offline use.")},updatefound:function(){console.log("New content is downloading.")},updated:function(){console.log("New content is available; please refresh.")},offline:function(){console.log("No internet connection found. App is running in offline mode.")},error:function(e){console.error("Error during service worker registration:",e)}});var le=n("ce5b"),pe=n.n(le);n("bf40");r["default"].config.productionTip=!1,r["default"].use(pe.a),new r["default"]({render:function(e){return e(oe)}}).$mount("#app")}});
//# sourceMappingURL=app.6b89d7a4.js.map